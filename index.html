<html>
<!--
	The canvas tower defense game! :)
    Copyright (C) 2013  RenÃ© van der Ark

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<head>
	<script type="text/javascript" src="rgbcolor.js"></script> 
	<script type="text/javascript" src="canvg.js"></script> 
	<script type="text/javascript" src="astarWorker.js"></script> 
	<script type="text/javascript" src="sprite.js"></script>
	<script type="text/javascript" src="grid.js"></script>
	<script type="text/javascript" src="gameobject.js"></script>
	<script type="text/javascript" src="creep.js"></script>
	<script type="text/javascript" src="tower.js"></script>
	<script type="text/javascript" src="sample.js"></script>

	<script type="text/javascript">
		var settings = { scaleFactor: 1.0 };
		var sounds = {};
		var sprites = {
			creep: new Sprite("creep.svg", 8, 8),
			pelletTower:  new Sprite("pellet.svg", 20, 20),
			bullet: new Sprite("bullet.svg", 5,5)
		};

		window.requestAnimFrame = (function(){
			return  window.requestAnimationFrame ||
			  window.webkitRequestAnimationFrame ||
			  window.mozRequestAnimationFrame ||
			  function(callback){
			    window.setTimeout(callback, 1000 / 60);
			  };
		})();


		window.onload = function() {
			var c = document.getElementById('canvas');
			doResize();
			var ctx = c.getContext('2d');
			var bbgCtx = document.getElementById('bbg').getContext('2d');
			var bgCtx = document.getElementById('bg').getContext('2d');
			var mgCtx = document.getElementById('mg').getContext('2d');

			var grid = new Grid(bbgCtx, ctx);
			var path = [];

			var creeps = [];
			var towers = [];
			var gameObjects = [];


			sounds.bullet = new Sample(new Audio("plop.wav"), {channels: 3});
			sounds.cheer = new Sample(new Audio("cheer.wav"), {channels: 3});
			sounds.death = new Sample(new Audio("death.wav"), {channels: 3});

			function doResize() {
				var c = document.getElementById('canvas');
				var ww = (window.innerWidth || document.body.clientWidth) - 50;
				var wh = (window.innerHeight || document.body.clientHeight) - 50;
				c.width =  (ww > wh ? wh : ww);
				c.height = c.width;
				document.getElementById('bbg').width = c.width;
				document.getElementById('bbg').height = c.height;
				document.getElementById('bg').width = c.width;
				document.getElementById('bg').height = c.height;
				document.getElementById('mg').width = c.width;
				document.getElementById('mg').height = c.height;
				settings.scaleFactor = 310 / c.width;
				sprites.creep.init(8,8);
				sprites.pelletTower.init(20,20);
				sprites.bullet.init(4,4);
				for(i in gameObjects) { if(gameObjects[i]) { gameObjects[i].setUpdated(true); } }
			}
			window.onresize = doResize;


			for(var i = 0; i < 10; ++i) {
				var creep = new Creep(sprites.creep, mgCtx, grid, {x: -(i), y: 15, zIndex: 1, speed: 0.3});
				creeps.push(creep);
				gameObjects.push(creep);
				creep.setTarget({x: 31, y: 15});
			}

			for(var i = 0; i < 10; ++i) {
				var creep = new Creep(sprites.creep, mgCtx, grid, {x: 15, y: -(i), zIndex: 1, speed: 0.3});
				creeps.push(creep);
				gameObjects.push(creep);
				creep.setTarget({x: 15, y: 31});
			}


			var target = {x : 0, y : 0};
			var blockNewPlacement = false;
			document.getElementById("canvas").onclick = function(e) {
				if(blockNewPlacement) {
					shinyMessage("still validating last placement");
				} else {
					var pelletTower = new PelletTower({bulletContext: bgCtx, context: mgCtx, grid: grid, x: grid.getGhost().x, y: grid.getGhost().y});
					blockNewPlacement = true;

					pelletTower.place({
						creeps: creeps,
						onSuccess: function() { 
							towers.push(pelletTower);
							gameObjects.push(pelletTower);
							gameObjects.push(pelletTower.getBullet());
							for(var i in creeps) {
								creeps[i].setPath(creeps[i].getNewPath());
							}
							blockNewPlacement = false;
						},
						onFailure: function(reason) {
							shinyMessage(reason);
							blockNewPlacement = false;
						}
					});
				}
			};

			document.getElementById("canvas").onmouseout = function(e) {
				grid.setGhost({ x : -1, y : -1 });
			};

			document.getElementById("canvas").onmousemove = function(e) {
				grid.setGhost({
					x : Math.floor(((e.pageX - this.offsetLeft) * settings.scaleFactor) / 10),
					y : Math.floor(((e.pageY - this.offsetTop) * settings.scaleFactor) / 10)
				});
			};

			function processActionQueue() {
				for(var i in towers) {
					towers[i].shootAtFirstWithinRange(creeps); 
				}
				for(var i in creeps) {
					if(creeps[i].isDead()) {
						creeps.splice(i, 1);
						shinyMessage(creeps.length + " creeps left")
					} else if(creeps[i].followPath()) {
						creeps[i].win();
						creeps.splice(i, 1);
						shinyMessage(creeps.length + " creeps left")
					}
				}
			}

			var redrawList = [];
			function pushUpdatesToCanvas() {
				for(var i in gameObjects) {
					if(gameObjects[i] && gameObjects[i].isUpdated() /**&& $.inArray(gameObjects[i], redrawList) == -1**/) {
						redrawList.push(gameObjects[i]);
					}
				}
				redrawList.sort(function(a,b) { return b.getZ() - a.getZ(); });
			}

			function processTick() {
				grid.clearGhost();
				grid.drawGhost();
				grid.drawOccupied();

				processActionQueue();
				pushUpdatesToCanvas();

				var start = new Date().getTime();
				var i = 0;
				var drawList = [];
				while(redrawList.length > 0 && ++i < 500) {
					var gameObject = redrawList.pop();
					gameObject.clear();
					drawList.push(gameObject);
				}

				for(var x in drawList) { drawList[x].draw(); }
				requestAnimFrame(processTick);
			}

			function pollForPaths() {
				for(var i in creeps) {
					if(creeps[i].isPathPending()) {
						setTimeout(pollForPaths, 1);
						return;
					} else { 
						creeps[i].setPath(creeps[i].getNewPath());
					}
				}
				processTick();
			}
			pollForPaths();
		};

		function shinyMessage(txt) {
			document.getElementById('msg').innerHTML = txt;
		}
	</script>
</head>
<body>
<a href="http://github.com/renevanderark/canvas-td">back to github</a>
<span id="msg"></span>
<canvas id="bbg" style="border: 1px solid; margin: 0; position: absolute; z-index: 0; left: 0; top: 30">
</canvas>
<canvas id="bg" style="border: 1px solid; margin: 0; position: absolute; z-index: 1; left: 0; top: 30">
</canvas>
<canvas id="mg" style="border: 1px solid; margin: 0; position: absolute; z-index: 2; left: 0; top: 30">
</canvas>
<canvas id="canvas" style="border: 1px solid; margin: 0; position: absolute; z-index: 3; left: 0; top: 30">
</canvas>


</html>
